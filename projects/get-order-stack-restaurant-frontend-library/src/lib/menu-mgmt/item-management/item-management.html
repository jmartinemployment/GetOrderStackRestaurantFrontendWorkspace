@if (isAuthenticated()) {
<div class="item-management">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 mb-0">Menu Items</h2>
    <div class="d-flex gap-2">
      <button
        type="button"
        class="btn btn-sm btn-outline-info ai-btn"
        [disabled]="isEstimating() || isGenerating()"
        (click)="estimateAllCosts()"
      >
        @if (isEstimating() === 'all') {
          <span class="spinner-border spinner-border-sm me-1"></span>
          Estimating...
        } @else {
          AI Estimate All Costs
        }
      </button>
      <button
        type="button"
        class="btn btn-sm btn-outline-info ai-btn"
        [disabled]="isEstimating() || isGenerating()"
        (click)="generateAllDescriptions()"
      >
        @if (isGenerating() === 'all') {
          <span class="spinner-border spinner-border-sm me-1"></span>
          Generating...
        } @else {
          AI Generate All Descriptions
        }
      </button>
      <button type="button" class="btn btn-primary" (click)="openCreateForm()">
        + Add Item
      </button>
    </div>
  </div>

  <!-- Category Filter -->
  <div class="category-filter mb-4">
    <div class="d-flex flex-wrap gap-2">
      <button
        type="button"
        class="btn btn-sm"
        [class.btn-primary]="!selectedCategoryId()"
        [class.btn-outline-light]="selectedCategoryId()"
        (click)="selectCategory(null)"
      >
        All Items
      </button>
      @for (category of categories(); track category.id) {
        <button
          type="button"
          class="btn btn-sm"
          [class.btn-primary]="selectedCategoryId() === category.id"
          [class.btn-outline-light]="selectedCategoryId() !== category.id"
          (click)="selectCategory(category.id)"
        >
          {{ category.name }}
        </button>
      }
    </div>
  </div>

  @if (localError()) {
    <get-order-stack-error-display
      [message]="localError()!"
      [retryable]="true"
      (dismissed)="clearLocalError()"
      (retry)="retry()"
    />
  }

  @if (!crudSupported()) {
    <div class="alert alert-info small py-2 px-3 mb-3">
      Edit, delete, and availability toggle are not yet available.
    </div>
  }

  @if (lastEstimation(); as estimation) {
    <div class="ai-estimation-result card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h6 class="mb-0">AI Cost Estimation Result</h6>
          <button
            type="button"
            class="btn-close btn-close-white btn-sm"
            (click)="dismissEstimation()"
          ></button>
        </div>
        <div class="d-flex flex-wrap gap-3 mb-2">
          <div>
            <span class="text-muted small">Est. Cost</span>
            <div class="fw-bold">{{ estimation.estimatedCost | currency }}</div>
          </div>
          <div>
            <span class="text-muted small">Suggested Price</span>
            <div class="fw-bold">{{ estimation.suggestedPrice | currency }}</div>
          </div>
          <div>
            <span class="text-muted small">Profit Margin</span>
            <div class="fw-bold">{{ estimation.profitMargin }}%</div>
          </div>
          <div>
            <span class="text-muted small">Confidence</span>
            <div>
              <span class="badge confidence-badge" [class]="getConfidenceBadgeClass(estimation.confidence)">
                {{ estimation.confidence }}
              </span>
            </div>
          </div>
        </div>
        <p class="small text-muted mb-0">{{ estimation.reasoning }}</p>
      </div>
    </div>
  }

  @if (isLoading()) {
    <div class="d-flex justify-content-center p-5">
      <get-order-stack-loading-spinner message="Loading items..." />
    </div>
  } @else {
    <div class="items-grid">
      @for (item of filteredItems(); track item.id) {
        <div class="item-card card" [class.unavailable]="item.isActive === false">
          @if (item.image) {
            <img [src]="item.image" [alt]="item.name" width="200" height="150" class="card-img-top" />
          }
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h5 class="card-title mb-1">
                  {{ item.name }}
                  @if (item.popular || item.isPopular) {
                    <span class="badge bg-warning text-dark ms-1">Popular</span>
                  }
                </h5>
                <span class="category-badge badge bg-secondary">
                  {{ getCategoryName(item.categoryId || '') }}
                </span>
              </div>
              <span class="price fw-bold">{{ item.price | currency }}</span>
            </div>

            @if (item.aiEstimatedCost) {
              <div class="ai-data d-flex flex-wrap gap-2 align-items-center mb-2">
                <span class="small">
                  Est. Cost: <strong>{{ item.aiEstimatedCost | currency }}</strong>
                </span>
                <span class="small">
                  Suggested: <strong>{{ item.aiSuggestedPrice | currency }}</strong>
                </span>
                <span class="small">
                  Margin: <strong>{{ item.aiProfitMargin }}%</strong>
                </span>
                @if (item.aiConfidence) {
                  <span class="badge confidence-badge" [class]="getConfidenceBadgeClass(item.aiConfidence)">
                    {{ item.aiConfidence }}
                  </span>
                }
              </div>
            }

            @if (item.description) {
              <p class="card-text small text-muted mb-2">{{ item.description }}</p>
            }

            @if (item.dietary && item.dietary.length > 0) {
              <div class="dietary-badges mb-2">
                @for (diet of item.dietary; track diet) {
                  <span class="badge bg-info me-1">{{ diet }}</span>
                }
              </div>
            }

            @if (item.isActive === false) {
              <div class="alert alert-warning py-1 px-2 small mb-2">
                Currently unavailable
              </div>
            }

            <div class="item-actions d-flex flex-wrap gap-2 mt-auto">
              <button
                type="button"
                class="btn btn-sm btn-outline-info ai-btn"
                [disabled]="isEstimating() || isGenerating()"
                (click)="estimateCost(item)"
              >
                @if (isEstimating() === item.id) {
                  <span class="spinner-border spinner-border-sm me-1"></span>
                } @else {
                  AI Cost
                }
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-info ai-btn"
                [disabled]="isEstimating() || isGenerating()"
                (click)="generateDescription(item)"
              >
                @if (isGenerating() === item.id) {
                  <span class="spinner-border spinner-border-sm me-1"></span>
                } @else {
                  AI Describe
                }
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-light flex-fill"
                [disabled]="!crudSupported()"
                (click)="toggleActive(item)"
              >
                {{ item.isActive !== false ? 'Mark Unavailable' : 'Mark Available' }}
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                [disabled]="!crudSupported()"
                (click)="openEditForm(item)"
              >
                Edit
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                [disabled]="!crudSupported()"
                (click)="deleteItem(item)"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      } @empty {
        <div class="empty-state text-center p-5">
          <p class="text-muted mb-3">
            @if (selectedCategoryId()) {
              No items in this category
            } @else {
              No menu items yet
            }
          </p>
          <button type="button" class="btn btn-primary" (click)="openCreateForm()">
            Add your first item
          </button>
        </div>
      }
    </div>
  }

  <!-- Item Form Modal -->
  @if (showForm()) {
    <div class="modal-overlay" (click)="closeForm()">
      <div class="modal-content card" (click)="$event.stopPropagation()">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            {{ editingItem() ? 'Edit Item' : 'New Item' }}
          </h4>
          <button type="button" class="btn-close btn-close-white" (click)="closeForm()"></button>
        </div>
        <form [formGroup]="itemForm" (ngSubmit)="saveItem()">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12 col-md-8">
                <label class="form-label">Item Name *</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="name"
                  placeholder="e.g., Chicken Tacos"
                />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">Price *</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input
                    type="number"
                    class="form-control"
                    formControlName="price"
                    min="0"
                    step="0.01"
                  />
                </div>
              </div>
            </div>

            <div class="mb-3 mt-3">
              <label class="form-label">Category *</label>
              <select class="form-select" formControlName="categoryId">
                <option value="">Select a category...</option>
                @for (category of categories(); track category.id) {
                  <option [value]="category.id">{{ category.name }}</option>
                }
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea
                class="form-control"
                rows="2"
                formControlName="description"
                placeholder="Brief description of the item..."
              ></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Image URL</label>
              <input
                type="url"
                class="form-control"
                formControlName="image"
                placeholder="https://..."
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Dietary Tags</label>
              <input
                type="text"
                class="form-control"
                formControlName="dietary"
                placeholder="e.g., Vegetarian, Gluten-Free, Vegan"
              />
              <small class="text-muted">Separate with commas</small>
            </div>

            <div class="d-flex gap-4">
              <div class="form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="isActive"
                  formControlName="isActive"
                />
                <label class="form-check-label" for="isActive">Available</label>
              </div>
              <div class="form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="isPopular"
                  formControlName="isPopular"
                />
                <label class="form-check-label" for="isPopular">Mark as Popular</label>
              </div>
            </div>
          </div>

          <div class="card-footer d-flex gap-2 justify-content-end">
            <button
              type="button"
              class="btn btn-outline-light"
              (click)="closeForm()"
              [disabled]="isSaving()"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="itemForm.invalid || isSaving()"
            >
              @if (isSaving()) {
                <span class="spinner-border spinner-border-sm me-2"></span>
                Saving...
              } @else {
                {{ editingItem() ? 'Update' : 'Create' }} Item
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
} @else {
  <div class="auth-required d-flex align-items-center justify-content-center p-5">
    <div class="text-center">
      <h3 class="text-warning mb-3">Authentication Required</h3>
      <p class="text-light">Please log in to manage menu items.</p>
    </div>
  </div>
}
