@if (isAuthenticated()) {
<div class="kds-display">
  <header class="kds-header d-flex justify-content-between align-items-center p-3">
    <div class="d-flex align-items-center gap-3">
      <h1 class="h4 mb-0">Kitchen Display</h1>
      @if (restaurantName()) {
        <span class="badge bg-secondary">{{ restaurantName() }}</span>
      }
    </div>
    <div class="d-flex align-items-center gap-3">
      <!-- KDS Stats -->
      <div class="kds-stats d-flex gap-3">
        <span class="stat">
          <span class="stat-value">{{ activeOrderCount() }}</span>
          <span class="stat-label">Active</span>
        </span>
        <span class="stat">
          <span class="stat-value" [class.text-danger]="overdueCount() > 0">{{ overdueCount() }}</span>
          <span class="stat-label">Overdue</span>
        </span>
        <span class="stat">
          <span class="stat-value">{{ avgWaitMinutes() }}m</span>
          <span class="stat-label">Avg Wait</span>
        </span>
      </div>
      <!-- Course Pacing Mode -->
      <div class="d-flex align-items-center gap-2">
        <label class="small text-muted mb-0">Courses:</label>
        <select
          class="form-select form-select-sm pacing-select"
          [value]="coursePacingMode()"
          (change)="setCoursePacingMode($event)"
        >
          @for (opt of pacingModeOptions; track opt.value) {
            <option [value]="opt.value">{{ opt.label }}</option>
          }
        </select>
      </div>
      <!-- Prep Time Firing Toggle -->
      <div class="d-flex align-items-center gap-2">
        <div class="form-check form-switch">
          <input
            class="form-check-input"
            type="checkbox"
            [checked]="prepTimeFiringEnabled()"
            (change)="togglePrepTimeFiring($event)"
          />
          <label class="form-check-label small text-muted">Stagger</label>
        </div>
      </div>
      <!-- Expo Station Toggle -->
      <div class="d-flex align-items-center gap-2">
        <div class="form-check form-switch">
          <input
            class="form-check-input"
            type="checkbox"
            [checked]="expoStationEnabled()"
            (change)="toggleExpoStation($event)"
          />
          <label class="form-check-label small text-muted">Expo</label>
        </div>
      </div>
      <get-order-stack-connection-status />
      <button type="button" class="btn btn-outline-light btn-sm" (click)="refresh()">
        Refresh
      </button>
    </div>
  </header>

  @if (error()) {
    <div class="p-3">
      <get-order-stack-error-display
        [message]="error()!"
        [retryable]="true"
        (dismissed)="clearError()"
        (retry)="refresh()"
      />
    </div>
  }

  @if (isLoading()) {
    <div class="d-flex justify-content-center p-5">
      <get-order-stack-loading-spinner message="Loading orders..." />
    </div>
  } @else {
    <div class="kds-columns" [class.kds-columns-4]="expoStationEnabled()">
      <!-- NEW Orders Column -->
      <div class="kds-column">
        <div class="column-header new">
          <h2 class="h5 mb-0">NEW</h2>
          <span class="badge bg-light text-dark">{{ pendingOrders().length }}</span>
        </div>
        <div class="column-body">
          @for (order of pendingOrders(); track order.guid) {
            <get-order-stack-order-card
              [order]="order"
              [estimatedPrepMinutes]="getEstimatedPrep(order)"
              [isRushed]="isRushed(order.guid)"
              [coursePacingMode]="coursePacingMode()"
              [prepTimeMap]="prepTimeMap()"
              [autoFireDelaySeconds]="autoFireDelay()"
              [prepTimeFiringEnabled]="prepTimeFiringEnabled()"
              [defaultPrepMinutes]="defaultPrepMinutes()"
              [printStatus]="getPrintStatus(order.guid)"
              (statusChange)="onStatusChange($event)"
              (rushToggle)="toggleRush($event)"
              (fireCourse)="onFireCourse($event)"
              (fireItemNow)="onFireItemNow($event)"
              (retryPrint)="onRetryPrint($event)"
              (recallOrder)="onRecall($event)"
            />
          } @empty {
            <div class="empty-state text-center p-4">
              <p class="text-muted mb-0">No new orders</p>
            </div>
          }
        </div>
      </div>

      <!-- COOKING Orders Column -->
      <div class="kds-column">
        <div class="column-header cooking">
          <h2 class="h5 mb-0">COOKING</h2>
          <span class="badge bg-light text-dark">{{ preparingOrders().length }}</span>
        </div>
        <div class="column-body">
          @for (order of preparingOrders(); track order.guid) {
            <get-order-stack-order-card
              [order]="order"
              [estimatedPrepMinutes]="getEstimatedPrep(order)"
              [isRushed]="isRushed(order.guid)"
              [coursePacingMode]="coursePacingMode()"
              [prepTimeMap]="prepTimeMap()"
              [autoFireDelaySeconds]="autoFireDelay()"
              [prepTimeFiringEnabled]="prepTimeFiringEnabled()"
              [defaultPrepMinutes]="defaultPrepMinutes()"
              [printStatus]="getPrintStatus(order.guid)"
              (statusChange)="onStatusChange($event)"
              (rushToggle)="toggleRush($event)"
              (fireCourse)="onFireCourse($event)"
              (fireItemNow)="onFireItemNow($event)"
              (retryPrint)="onRetryPrint($event)"
              (recallOrder)="onRecall($event)"
            />
          } @empty {
            <div class="empty-state text-center p-4">
              <p class="text-muted mb-0">No orders cooking</p>
            </div>
          }
        </div>
      </div>

      <!-- EXPO Orders Column (only when expo enabled) -->
      @if (expoStationEnabled()) {
        <div class="kds-column">
          <div class="column-header expo">
            <h2 class="h5 mb-0">EXPO</h2>
            <span class="badge bg-light text-dark">{{ expoQueueOrders().length }}</span>
          </div>
          <div class="column-body">
            @for (order of expoQueueOrders(); track order.guid) {
              <get-order-stack-order-card
                [order]="order"
                [estimatedPrepMinutes]="getEstimatedPrep(order)"
                [isRushed]="isRushed(order.guid)"
                [isExpoQueue]="true"
                [coursePacingMode]="coursePacingMode()"
                [prepTimeMap]="prepTimeMap()"
                [autoFireDelaySeconds]="autoFireDelay()"
                [prepTimeFiringEnabled]="prepTimeFiringEnabled()"
                [defaultPrepMinutes]="defaultPrepMinutes()"
                [printStatus]="getPrintStatus(order.guid)"
                (expoCheck)="onExpoCheck($event)"
                (rushToggle)="toggleRush($event)"
                (retryPrint)="onRetryPrint($event)"
                (recallOrder)="onRecall($event)"
              />
            } @empty {
              <div class="empty-state text-center p-4">
                <p class="text-muted mb-0">No orders to verify</p>
              </div>
            }
          </div>
        </div>
      }

      <!-- READY Orders Column -->
      <div class="kds-column">
        <div class="column-header ready">
          <h2 class="h5 mb-0">READY</h2>
          <span class="badge bg-light text-dark">{{ expoCheckedOrders().length }}</span>
        </div>
        <div class="column-body">
          @for (order of expoCheckedOrders(); track order.guid) {
            <get-order-stack-order-card
              [order]="order"
              [estimatedPrepMinutes]="getEstimatedPrep(order)"
              [isRushed]="isRushed(order.guid)"
              [coursePacingMode]="coursePacingMode()"
              [prepTimeMap]="prepTimeMap()"
              [autoFireDelaySeconds]="autoFireDelay()"
              [prepTimeFiringEnabled]="prepTimeFiringEnabled()"
              [defaultPrepMinutes]="defaultPrepMinutes()"
              [printStatus]="getPrintStatus(order.guid)"
              (statusChange)="onStatusChange($event)"
              (rushToggle)="toggleRush($event)"
              (fireCourse)="onFireCourse($event)"
              (fireItemNow)="onFireItemNow($event)"
              (retryPrint)="onRetryPrint($event)"
              (recallOrder)="onRecall($event)"
            />
          } @empty {
            <div class="empty-state text-center p-4">
              <p class="text-muted mb-0">No orders ready</p>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
} @else {
  <div class="auth-required d-flex align-items-center justify-content-center p-5">
    <div class="text-center">
      <h3 class="text-warning mb-3">Authentication Required</h3>
      <p class="text-light">Please log in to view the kitchen display.</p>
    </div>
  </div>
}
